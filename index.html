<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Value V.1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base and Typography --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }

        /* --- Dynamic Theme Variables --- */
        :root {
            /* Default/Fallback Theme (Indigo) */
            --theme-primary: #4f46e5; /* indigo-600 */
            --theme-primary-hover: #4338ca; /* indigo-700 */
            --theme-secondary: #818cf8; /* indigo-400 */
            --theme-text: #4f46e5; /* indigo-600 */
        }

        /* Staff Themes */
        body.theme-hm {
            --theme-primary: #475569; /* slate-600 */
            --theme-primary-hover: #334155; /* slate-700 */
            --theme-secondary: #94a3b8; /* slate-400 */
            --theme-text: #475569;
        }
        body.theme-teacher {
            --theme-primary: #0d9488; /* teal-600 */
            --theme-primary-hover: #0f766e; /* teal-700 */
            --theme-secondary: #5eead4; /* teal-300 */
            --theme-text: #0d9488;
        }

        /* House Themes */
        body.theme-blue {
            --theme-primary: #0ea5e9; /* sky-500 */
            --theme-primary-hover: #0284c7; /* sky-600 */
            --theme-secondary: #7dd3fc; /* sky-300 */
            --theme-text: #0ea5e9;
        }
        body.theme-green {
            --theme-primary: #10b981; /* emerald-500 */
            --theme-primary-hover: #059669; /* emerald-600 */
            --theme-secondary: #6ee7b7; /* emerald-300 */
            --theme-text: #10b981;
        }
        body.theme-yellow {
            --theme-primary: #f59e0b; /* amber-500 */
            --theme-primary-hover: #d97706; /* amber-600 */
            --theme-secondary: #fcd34d; /* amber-300 */
            --theme-text: #f59e0b;
        }
        body.theme-rose {
            --theme-primary: #f43f5e; /* rose-500 */
            --theme-primary-hover: #e11d48; /* rose-600 */
            --theme-secondary: #fda4af; /* rose-300 */
            --theme-text: #f43f5e;
        }

        /* --- Component Styles --- */
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            padding: 1.5rem;
            transition: box-shadow 0.2s ease;
        }
        .dashboard-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -2px rgb(0 0 0 / 0.07);
        }
        .custom-table {
            width: 100%;
            border-collapse: collapse;
        }
        .custom-table th, .custom-table td { padding: 1rem 1.5rem; text-align: left; }
        .custom-table thead { background-color: #f8fafc; }
        .custom-table th { font-weight: 600; color: #475569; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .custom-table tbody tr { border-bottom: 1px solid #e2e8f0; }
        .custom-table tbody tr:last-child { border-bottom: none; }
        .custom-table tbody tr:hover { background-color: #f1f5f9; }
        
        .trend-up { color: #16a34a; }
        .trend-down { color: #dc2626; }
        .trend-stable { color: #64748b; }
        #closeModal, #closeIframeModal, #closeSwitchChildModal, #closeDobVerifyModal { font-size: 2rem; line-height: 1; font-weight: bold; }

        /* Grade Colors */
        .grade-a-plus, .grade-a { color: #16a34a; } /* Green */
        .grade-b-plus, .grade-b { color: #0ea5e9; } /* Sky */
        .grade-c-plus, .grade-c { color: #f59e0b; } /* Amber */
        .grade-d-plus, .grade-d { color: #f97316; } /* Orange */
        .grade-e { color: #dc2626; } /* Red */


        /* --- Action Button Styles --- */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            transition: background-color 0.2s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        /* --- Progress Bar Styles --- */
        .progress-bar-container {
            background-color: rgba(129, 140, 248, 0.2); /* indigo-300 with opacity */
            overflow: hidden;
        }
        .progress-bar {
            background-color: var(--theme-primary);
            width: 100%;
            height: 100%;
            animation: indeterminate-progress 1.5s infinite ease-in-out;
            transform-origin: 0% 50%;
        }

        @keyframes indeterminate-progress {
            0% { transform: translateX(-100%) scaleX(0.1); }
            40% { transform: translateX(0) scaleX(0.4); }
            100% { transform: translateX(100%) scaleX(0.5); }
        }

        /* --- Themed Element Styles --- */
        .themed-bg { background-color: var(--theme-primary); }
        .themed-bg:hover { background-color: var(--theme-primary-hover); }
        .themed-text { color: var(--theme-text); }
        .themed-secondary-bg { background-color: var(--theme-secondary); }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    
    <div id="progressBarContainer" class="fixed top-0 left-0 w-full h-1 z-[100] hidden">
        <div class="progress-bar"></div>
    </div>

    <div id="loginView" class="flex items-center justify-center min-h-screen bg-slate-100">
        <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">Emmanuel's HSS Kothanalloor</h1>
                <p class="mt-2 text-gray-500">E-Value V.1.0</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div>
                    <label for="phone" class="text-sm font-medium text-gray-700">Phone Number</label>
                    <input id="phone" name="phone" type="tel" autocomplete="tel" required class="appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mt-1" placeholder="Enter your or your child's phone number">
                </div>
                <div>
                    <label for="dob" class="text-sm font-medium text-gray-700">Date of Birth</label>
                    <input id="dob" name="dob" type="date" required class="appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm mt-1">
                    <p class="text-xs text-gray-500 mt-1">Parents: Please enter your child's date of birth.</p>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        Login
                    </button>
                </div>
                <p id="loginError" class="text-center text-sm text-red-600"></p>
            </form>
        </div>
    </div>

    <div id="dashboardView" class="hidden">
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span id="headerTitle" class="font-bold text-xl themed-text">E-Value V.1.0</span>
                    </div>
                    <div id="header-search-container" class="relative hidden w-1/3">
                        <input type="search" id="headerSearch" placeholder="Find a student..." class="w-full p-2 pl-4 rounded-full border border-gray-300 bg-slate-100 focus:outline-none focus:ring-2 focus:ring-[var(--theme-primary)]">
                        <div id="headerSearchResults" class="absolute top-full mt-1 w-full bg-white rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="userInfo" class="text-right mr-4"></div>
                        <button id="logoutButton" class="text-sm font-medium text-white themed-bg px-4 py-2 rounded-full transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </header>
        
        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="dashboard-container" class="space-y-8">
                <div class="text-center py-20"><p class="text-gray-500">Loading Dashboard...</p></div>
            </div>
        </main>
    </div>

    <div id="disciplineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Discipline & Activity Log</h3>
                <button id="closeModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-content" class="p-6 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="iframeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="iframeModalTitle" class="text-xl font-semibold text-gray-800">Loading...</h3>
                <button id="closeIframeModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="flex-grow p-2">
                <iframe id="modalIframe" src="" class="w-full h-full border-0"></iframe>
            </div>
        </div>
    </div>

    <div id="switchChildModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Switch Child Profile</h3>
                <button id="closeSwitchChildModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="switchChildList" class="p-6"></div>
        </div>
    </div>

    <div id="dobVerifyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
             <div class="p-6 border-b flex justify-between items-center">
                <h3 id="dobVerifyTitle" class="text-xl font-semibold text-gray-800">Verify Child's Date of Birth</h3>
                <button id="closeDobVerifyModal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="dobVerifyForm" class="p-6 space-y-4">
                <input type="hidden" id="dobVerifyAdmissionNo">
                <div>
                    <label for="dobVerifyInput" class="text-sm font-medium text-gray-700">Date of Birth</label>
                    <input id="dobVerifyInput" type="date" required class="mt-1 appearance-none rounded-lg relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white themed-bg">Verify & Switch</button>
                <p id="dobError" class="text-center text-sm text-red-600"></p>
            </form>
        </div>
    </div>


<script type="module">
    // --- GLOBAL STATE ---
    let currentUser = null;
    let appData = { users: [], marks: [], activities: [], processedStudents: [] };
    let standingsChart = null;

    // --- ACTIVITY RULES ---
    const activityRules = {
        "Class Cleaning": 5, "Assembly Appearance": 5, "Response in Class Activities": 5,
        "Competitive Winner": 10, "Extra Curricular Activities": 10, "Helping Mind": 10,
        "Class Performance": 10, "Participation in common activities": 10,
        "Bad Words": -15, "Fighting": -20, "Misbehaviour in public place": -20,
        "Misbehaviour towards teachers": -15, "Without ID Card": -10, "Indiscipline": -10,
        "Misbehaviour in Assembly": -10, "Indisciplinary activity at anytime": -10,
        "Personal Hygiene": -10, "Incomplete Uniform": -5, "Missing Homework": -5,
        "Play during interval": -5
    };

    // --- DATABASE (IndexedDB) HELPER ---
    const DB_NAME = 'StudentPortalDB_SPA';
    const DB_VERSION = 3; 
    let db;

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (db.objectStoreNames.contains('users')) {
                    db.deleteObjectStore('users');
                }
                db.createObjectStore('users', { autoIncrement: true });
                
                if (!db.objectStoreNames.contains('marks')) db.createObjectStore('marks', { keyPath: 'admissionNo' });
                if (!db.objectStoreNames.contains('activities')) db.createObjectStore('activities', { autoIncrement: true });
                if (!db.objectStoreNames.contains('session')) db.createObjectStore('session', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('metadata')) db.createObjectStore('metadata', { keyPath: 'key' });
            };
            request.onsuccess = e => { db = e.target.result; resolve(db); };
            request.onerror = e => { console.error('DB error:', e.target.error); reject('Error opening DB'); };
        });
    }

    async function isDataLoaded() {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['users'], 'readonly');
            const countRequest = transaction.objectStore('users').count();
            countRequest.onsuccess = () => resolve(countRequest.result > 0);
            countRequest.onerror = e => reject(e.target.error);
        });
    }

    async function populateDB() {
        if (!db) await openDB();
        const [usersRes, marksRes, activitiesRes] = await Promise.all([
            fetch('./users.json'),
            fetch('./marks.json'),
            fetch('./activities.json')
        ]);
        const users = await usersRes.json();
        const marks = await marksRes.json();
        const activities = await activitiesRes.json();

        const transaction = db.transaction(['users', 'marks', 'activities', 'metadata'], 'readwrite');
        const usersStore = transaction.objectStore('users');
        const marksStore = transaction.objectStore('marks');
        const activitiesStore = transaction.objectStore('activities');
        const metadataStore = transaction.objectStore('metadata');
        
        users.forEach(item => usersStore.put(item));
        marks.forEach(item => marksStore.put(item));
        activities.forEach(item => activitiesStore.put(item));
        metadataStore.put({ key: 'lastUpdated', value: new Date().toISOString() });
        
        return new Promise((resolve, reject) => {
            transaction.oncomplete = () => resolve();
            transaction.onerror = e => reject(e.target.error);
        });
    }

    async function getAllData() {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['users', 'marks', 'activities', 'metadata'], 'readonly');
            const requests = {
                users: transaction.objectStore('users').getAll(),
                marks: transaction.objectStore('marks').getAll(),
                activities: transaction.objectStore('activities').getAll(),
                metadata: transaction.objectStore('metadata').get('lastUpdated')
            };
            const results = {};
            transaction.oncomplete = () => resolve(results);
            transaction.onerror = e => reject(e.target.error);
            requests.users.onsuccess = () => results.users = requests.users.result;
            requests.marks.onsuccess = () => results.marks = requests.marks.result;
            requests.activities.onsuccess = () => results.activities = requests.activities.result;
            requests.metadata.onsuccess = () => results.metadata = requests.metadata.result;
        });
    }

    async function setSession(user) {
        if (!db) await openDB();
        const transaction = db.transaction(['session'], 'readwrite');
        transaction.objectStore('session').put({ id: 'currentUser', ...user });
    }

    async function getSession() {
        if (!db) await openDB();
        return new Promise((resolve, reject) => {
            const request = db.transaction(['session'], 'readonly').objectStore('session').get('currentUser');
            request.onsuccess = () => resolve(request.result || null);
            request.onerror = e => reject(e.target.error);
        });
    }

    async function clearSessionAndData() {
        localStorage.clear();
        if (db) {
            db.close();
            db = null;
        }
        return new Promise((resolve, reject) => {
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            deleteRequest.onsuccess = () => resolve();
            deleteRequest.onerror = (e) => reject('Error deleting database.', e);
            deleteRequest.onblocked = () => reject('Database delete blocked. Please close other tabs with this app open.');
        });
    }

    // --- DATA PROCESSING & CALCULATIONS ---
    function processStudentData(students, marksData, activities) {
        const studentsByClass = students.reduce((acc, student) => {
            const classKey = `${student.class}-${student.division}`;
            if (!acc[classKey]) acc[classKey] = [];
            acc[classKey].push(student);
            return acc;
        }, {});

        let finalProcessedStudents = [];
        for (const classKey in studentsByClass) {
            const classStudents = studentsByClass[classKey];
            const studentScores = classStudents.map(student => {
                const studentMarksRecord = marksData.find(m => m.admissionNo.toString() === student.admissionNo.toString());
                let academicTotal = 0;
                if (studentMarksRecord && studentMarksRecord.terms) {
                    academicTotal = Object.values(studentMarksRecord.terms).reduce((sum, term) => sum + (typeof term.total === 'number' ? term.total : 0), 0);
                }
                
                const disciplinePoints = activities
                    .filter(a => a.admissionNo.toString() === student.admissionNo.toString())
                    .reduce((sum, act) => {
                        const basePoints = activityRules[act.Activity] || 0;
                        const calculatedPoints = (act.Rating / 5) * basePoints;
                        return sum + calculatedPoints;
                    }, 0);

                const housePoints = academicTotal + disciplinePoints;

                return { ...student, academicTotal, disciplinePoints, housePoints, marksRecord: studentMarksRecord };
            });
            studentScores.sort((a, b) => b.academicTotal - a.academicTotal).forEach((s, i) => s.academicRank = i + 1);
            studentScores.sort((a, b) => b.disciplinePoints - a.disciplinePoints).forEach((s, i) => s.disciplineRank = i + 1);
            finalProcessedStudents.push(...studentScores);
        }
        return finalProcessedStudents;
    }

    function getSection(className) {
        const classNum = parseInt(className, 10);
        if (classNum >= 1 && classNum <= 4) return 'LP';
        if (classNum >= 5 && classNum <= 7) return 'UP';
        if (classNum >= 8 && classNum <= 10) return 'HS';
        return 'Other';
    }
    
    function getTeacherSection(designation) {
        if (designation === 'LPST') return 'LP';
        if (designation === 'UPST') return 'UP';
        if (designation && (designation.startsWith('HST') || designation === 'PET' || designation === 'Drawing Teacher')) return 'HS';
        return null;
    }

    function customClassSort(a, b) {
        const partsA = a.split('-');
        const partsB = b.split('-');
        const numA = parseInt(partsA[0], 10);
        const numB = parseInt(partsB[0], 10);
        if (numA !== numB) return numA - numB;
        return (partsA[1] || '').localeCompare(partsB[1] || '');
    }

    // --- Centralized Grade Calculation Helper ---
    function getGradeInfo(mark, subject, termKey, studentClass) {
        const section = getSection(studentClass);
        const classNum = parseInt(studentClass, 10);
        let maxMark = 100; // Default

        const termLower = termKey.toLowerCase();
        if (termLower.includes('monthly exam 01') || termLower.includes('first mid term')) {
            maxMark = 20;
        } else if (termLower.includes('first term')) {
            if (section === 'UP') {
                maxMark = 30;
            } else if (classNum === 8) {
                maxMark = ['Physics', 'Chemistry', 'Biology'].includes(subject) ? 20 : 40;
            } else if (classNum === 9 || classNum === 10) {
                maxMark = ['English', 'Social Science', 'Maths'].includes(subject) ? 80 : 40;
            } else if (section === 'LP') {
                maxMark = 25;
            }
        }
        
        if (typeof mark !== 'number' || mark === null || mark === undefined) {
            return { grade: 'Ab', cssClass: '', maxMark: maxMark };
        }

        const percentage = (mark / maxMark) * 100;

        if (section === 'UP' || classNum === 8) {
            if (percentage >= 80) return { grade: 'A', cssClass: 'grade-a', maxMark };
            if (percentage >= 60) return { grade: 'B', cssClass: 'grade-b', maxMark };
            if (percentage >= 40) return { grade: 'C', cssClass: 'grade-c', maxMark };
            if (percentage >= 30) return { grade: 'D', cssClass: 'grade-d', maxMark };
            return { grade: 'E', cssClass: 'grade-e', maxMark };
        } else if (classNum === 9 || classNum === 10) {
            if (percentage >= 90) return { grade: 'A+', cssClass: 'grade-a-plus', maxMark };
            if (percentage >= 80) return { grade: 'A', cssClass: 'grade-a', maxMark };
            if (percentage >= 70) return { grade: 'B+', cssClass: 'grade-b-plus', maxMark };
            if (percentage >= 60) return { grade: 'B', cssClass: 'grade-b', maxMark };
            if (percentage >= 50) return { grade: 'C+', cssClass: 'grade-c-plus', maxMark };
            if (percentage >= 40) return { grade: 'C', cssClass: 'grade-c', maxMark };
            if (percentage >= 30) return { grade: 'D+', cssClass: 'grade-d-plus', maxMark };
            if (percentage >= 20) return { grade: 'D', cssClass: 'grade-d', maxMark };
            return { grade: 'E', cssClass: 'grade-e', maxMark };
        } else {
            if (percentage >= 90) return { grade: 'A+', cssClass: 'grade-a-plus', maxMark };
            if (percentage >= 80) return { grade: 'A', cssClass: 'grade-a', maxMark };
            if (percentage >= 70) return { grade: 'B+', cssClass: 'grade-b-plus', maxMark };
            if (percentage >= 60) return { grade: 'B', cssClass: 'grade-b', maxMark };
            if (percentage >= 50) return { grade: 'C+', cssClass: 'grade-c-plus', maxMark };
            if (percentage >= 40) return { grade: 'C', cssClass: 'grade-c', maxMark };
            if (percentage >= 30) return { grade: 'D+', cssClass: 'grade-d-plus', maxMark };
            if (percentage >= 20) return { grade: 'D', cssClass: 'grade-d', maxMark };
            return { grade: 'E', cssClass: 'grade-e', maxMark };
        }
    }

    // --- UI RENDERING ---
    const dashboardContainer = document.getElementById('dashboard-container');

    function buildHMDashboard(user, allStudents, processedStudents, metadata) {
        const lastUpdated = metadata ? new Date(metadata.value).toLocaleString() : 'Not available';
        dashboardContainer.innerHTML = `
            <div class="dashboard-card"><h2 class="text-2xl font-bold text-gray-800 mb-4">Quick Actions</h2><div class="flex flex-wrap gap-4"><button class="action-btn bg-blue-500 hover:bg-blue-600" data-action="discipline"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd" /></svg>Discipline Entry</button><a href="https://docs.google.com/spreadsheets/d/1RcXcqDDMi2sAjXGgEyKIFKjwVVmkikfj/edit" target="_blank" class="action-btn bg-green-500 hover:bg-green-600">LP Marks</a><a href="https://docs.google.com/spreadsheets/d/17vdYpWYELcUE--q_9s2JaGcT-GwgNX28/edit" target="_blank" class="action-btn bg-yellow-500 hover:bg-yellow-600">UP Marks</a><a href="https://docs.google.com/spreadsheets/d/1qSlfrIqTrJGg_zN-R7b9zVRBG0l-OB8K/edit" target="_blank" class="action-btn bg-red-500 hover:bg-red-600">HS Marks</a></div></div>
            <div class="dashboard-card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">House Standings</h2><select id="standingsFilter" class="p-2 rounded-lg border border-gray-300"><option value="school">School-wide</option></select></div><div style="height: 300px;"><canvas id="standingsChart"></canvas></div><p class="text-xs text-gray-500 mt-2 text-right">Data last synced: ${lastUpdated}</p></div>
            <div id="leaderboardCard"></div>
            <div id="classToppersCard"></div>
            <div id="subjectToppersCard"></div>`;

        buildStandingsChart(processedStudents);
        buildLeaderboardCard(processedStudents, appData.activities, false);
        buildClassToppersCard(processedStudents);
        buildSubjectToppersCard(processedStudents);
        dashboardContainer.addEventListener('click', handleDashboardClick);
    }

    function buildTeacherDashboard(user, allStudents, processedStudents, metadata) {
        const teacherSection = getTeacherSection(user.designation);
        if (!teacherSection) {
            dashboardContainer.innerHTML = `<div class="dashboard-card text-red-500"><h2 class="text-2xl font-bold">Configuration Error</h2><p>Your user profile is missing a valid section in designation (LPST, UPST, HST). Please contact an administrator.</p></div>`;
            return;
        }

        const sectionStudents = processedStudents.filter(s => getSection(s.class) === teacherSection);
        const markEntryUrl = {
            lp: "https://docs.google.com/spreadsheets/d/1RcXcqDDMi2sAjXGgEyKIFKjwVVmkikfj/edit",
            up: "https://docs.google.com/spreadsheets/d/1RyqclF_XUeMHNY3yAsJ8m4i1e3RDJOGQVor_4KyRqDU/edit?usp=sharing",
            hs: "https://docs.google.com/spreadsheets/d/16xR0xvCIR1ulNVzB0D2ZddccDFLlwwLAuFZp_m5IJLI/edit?usp=sharing"
        }[teacherSection.toLowerCase()];
        const lastUpdated = metadata ? new Date(metadata.value).toLocaleString() : 'Not available';

        dashboardContainer.innerHTML = `
            <div class="dashboard-card"><h2 class="text-2xl font-bold text-gray-800 mb-4">Quick Actions</h2><div class="flex flex-wrap gap-4"><button class="action-btn bg-blue-500 hover:bg-blue-600" data-action="discipline">Discipline Entry</button><a href="${markEntryUrl}" target="_blank" class="action-btn bg-green-500 hover:bg-green-600">${teacherSection} Mark Entry</a></div></div>
            <div class="dashboard-card"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">House Standings (${teacherSection})</h2><select id="standingsFilter" class="p-2 rounded-lg border border-gray-300"><option value="section">Section-wide</option></select></div><div style="height: 300px;"><canvas id="standingsChart"></canvas></div><p class="text-xs text-gray-500 mt-2 text-right">Data last synced: ${lastUpdated}</p></div>
            <div id="leaderboardCard"></div>
            <div id="classToppersCard"></div>
            <div id="subjectToppersCard"></div>
            <div id="reportGeneratorCard"></div>`;

        buildStandingsChart(sectionStudents, true);
        buildLeaderboardCard(sectionStudents, appData.activities, true);
        buildClassToppersCard(sectionStudents);
        buildSubjectToppersCard(sectionStudents);
        buildReportGeneratorCard(sectionStudents);
        dashboardContainer.addEventListener('click', handleDashboardClick);
    }

    function buildStudentDashboard(student, activities, viewer = null, siblings = []) {
        const { marksRecord } = student;
        if (!marksRecord || !marksRecord.terms) {
            dashboardContainer.innerHTML = `<div class="dashboard-card"><p class="text-center text-gray-500">No marks data found for this student.</p></div>`;
            return;
        }

        const studentActivities = activities.filter(a => a.admissionNo.toString() === student.admissionNo.toString());
        const termOrder = ["Monthly Exam 01", "First Mid Term Exam", "First Term Exam"];
        const termKeys = Object.keys(marksRecord.terms).sort((a, b) => termOrder.indexOf(a) - termOrder.indexOf(b));
        const allSubjects = [...new Set(termKeys.flatMap(key => Object.keys(marksRecord.terms[key].marks)))];
        
        const getTrend = (subject, currentTermKey) => {
            const currentTermIndex = termKeys.indexOf(currentTermKey);
            if (currentTermIndex < 1) return '<span>-</span>';
            const prevTermKey = termKeys[currentTermIndex - 1];
            const currentMark = marksRecord.terms[currentTermKey].marks[subject];
            const prevMark = marksRecord.terms[prevTermKey].marks[subject];
            if (typeof currentMark !== 'number' || typeof prevMark !== 'number') return '<span>-</span>';
            if (currentMark > prevMark) return `<span class="trend-up">&uarr; Improving</span>`;
            if (currentMark < prevMark) return `<span class="trend-down">&darr; Declining</span>`;
            return `<span class="trend-stable">&rarr; Stable</span>`;
        };

        let previousRank = null;
        const termCardsHTML = termKeys.map(key => {
            const term = marksRecord.terms[key];
            const maxTotal = Object.values(term.marks || {}).length * 25; // Note: This is a simplification
            const percentage = maxTotal > 0 ? ((term.total / maxTotal) * 100).toFixed(1) : 0;
            let rankChangeHTML = '';
            if (previousRank !== null && typeof term.rank === 'number') {
                const change = previousRank - term.rank;
                if (change > 0) rankChangeHTML = `<span class="text-sm text-green-600 font-medium ml-2">(+${change})</span>`;
                else if (change < 0) rankChangeHTML = `<span class="text-sm text-red-600 font-medium ml-2">(${change})</span>`;
            }
            previousRank = term.rank;
            return `<div class="bg-white rounded-lg shadow p-4 flex flex-col"><h3 class="font-semibold text-gray-500 text-center border-b pb-2 mb-3">${key}</h3><div class="space-y-2 text-gray-700"><p><span class="font-bold text-lg">Total: ${term.total || 'N/A'}</span> marks</p><p>Rank: ${term.rank || 'N/A'}${rankChangeHTML}</p><p>Percentage: ${percentage}%</p></div></div>`;
        }).join('');

        const detailedMarksHTML = allSubjects.map(subject => {
            const cells = termKeys.map(k => {
                const mark = marksRecord.terms[k].marks[subject];
                const displayMark = (mark !== undefined && mark !== null) ? mark : '-';
                const { grade, cssClass: gradeClass } = getGradeInfo(mark, subject, k, student.class);
                return `<td class="text-center font-medium">${displayMark}<br><span class="font-bold ${gradeClass}">${grade}</span></td>`;
            }).join('');
            const trend = getTrend(subject, termKeys[termKeys.length - 1]);
            return `<tr><td class="font-medium">${subject}</td>${cells}<td class="text-center">${trend}</td></tr>`;
        }).join('');
        
        const backButtonHTML = viewer && viewer.role === 'staff' ? `<div class="mb-6"><button id="backToDashboardBtn" class="text-sm font-medium text-white bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded-lg">&larr; Back to Dashboard</button></div>` : '';
        const switchChildButtonHTML = siblings.length > 0 ? `<button id="switchChildBtn" class="ml-4 text-sm font-medium text-white themed-bg px-4 py-2 rounded-full">Switch Child</button>` : '';

        dashboardContainer.innerHTML = backButtonHTML + `
            <div class="dashboard-card flex flex-wrap justify-between items-center gap-4"><div><h2 class="text-3xl font-bold text-gray-800">${student.name}</h2><p class="text-gray-500">Class ${student.class}-${student.division} | Adm No: ${student.admissionNo} | House: ${student.house}</p></div><div class="flex items-center gap-4 text-center">${switchChildButtonHTML}<div><p class="text-2xl font-bold themed-text">#${student.academicRank}</p><p class="text-sm text-gray-500">Academic Rank (Class)</p></div><div><p class="text-2xl font-bold themed-text">#${student.disciplineRank}</p><p class="text-sm text-gray-500">Discipline Rank (Class)</p></div></div></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">${termCardsHTML}</div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="dashboard-card"><h3 class="font-semibold mb-4">Subject-wise Marks</h3><div style="height: 300px;"><canvas id="subjectChart"></canvas></div></div><div class="dashboard-card"><h3 class="font-semibold mb-4">Term-wise Performance</h3><div style="height: 300px;"><canvas id="termChart"></canvas></div></div></div>
            <div class="dashboard-card"><div class="flex justify-between items-center mb-4"><h3 class="font-semibold">Detailed Marks Summary</h3><button id="showDiscipline" class="text-sm font-medium text-white themed-bg px-4 py-2 rounded-lg">View Discipline Log (${student.disciplinePoints.toFixed(0)} pts)</button></div><div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>Subject</th>${termKeys.map(k => `<th class="text-center">${k}</th>`).join('')}<th>Progress</th></tr></thead><tbody>${detailedMarksHTML}</tbody></table></div></div>`;
        
        if (viewer) {
            document.getElementById('backToDashboardBtn')?.addEventListener('click', () => initializeApp(currentUser));
        }
        if (siblings.length > 0) {
            document.getElementById('switchChildBtn').addEventListener('click', () => showSwitchChildModal(siblings));
        }

        const subjectChartCtx = document.getElementById('subjectChart').getContext('2d');
        const chartColors = ['#818cf880', '#f8717180', '#fbbf2480', '#4ade8080'];
        const chartBorderColors = ['#6366f1', '#ef4444', '#d97706', '#22c55e'];
        const subjectChartDatasets = termKeys.map((key, index) => ({
            label: key,
            data: allSubjects.map(subject => { const mark = marksRecord.terms[key].marks[subject]; return typeof mark === 'number' ? mark : 0; }),
            backgroundColor: chartColors[index % chartColors.length],
            borderColor: chartBorderColors[index % chartBorderColors.length],
            borderWidth: 2,
            pointBackgroundColor: chartBorderColors[index % chartBorderColors.length]
        }));
        new Chart(subjectChartCtx, { type: 'radar', data: { labels: allSubjects, datasets: subjectChartDatasets }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true } } } });

        const termChartCtx = document.getElementById('termChart').getContext('2d');
        const termData = termKeys.map(k => {
            const term = marksRecord.terms[k];
            const maxTotal = Object.keys(term.marks || {}).length * 25;
            const percentage = maxTotal > 0 ? (term.total / maxTotal) * 100 : 0;
            return { total: term.total, rank: term.rank, percentage: percentage };
        });
        new Chart(termChartCtx, {
            type: 'bar',
            data: {
                labels: termKeys.map(k => k),
                datasets: [
                    { label: 'Total Marks', data: termData.map(d => d.total), backgroundColor: '#a5b4fc', yAxisID: 'y-total', order: 2 },
                    { label: 'Percentage (%)', data: termData.map(d => d.percentage), type: 'line', borderColor: '#10b981', yAxisID: 'y-percent', tension: 0.2, order: 1 },
                    { label: 'Rank', data: termData.map(d => d.rank), type: 'line', borderColor: '#f43f5e', yAxisID: 'y-rank', tension: 0.2, order: 1 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { 'y-total': { type: 'linear', position: 'left', title: { display: true, text: 'Total Marks' } }, 'y-percent': { type: 'linear', position: 'right', display: false, max: 100, min: 0 }, 'y-rank': { type: 'linear', position: 'right', reverse: true, title: { display: true, text: 'Rank' }, grid: { drawOnChartArea: false } } } }
        });
        
        const modal = document.getElementById('disciplineModal');
        document.getElementById('showDiscipline').addEventListener('click', () => {
            document.getElementById('modal-content').innerHTML = `<div class="overflow-x-auto"><table class="custom-table"><thead><tr><th>Date</th><th>Activity</th><th>Points</th></tr></thead><tbody>${studentActivities.length > 0 ? studentActivities.map(act => `<tr><td>${new Date(act.Timestamp).toLocaleDateString()}</td><td>${act.Activity}</td><td class="${(activityRules[act.Activity] || 0) > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">${((act.Rating / 5) * (activityRules[act.Activity] || 0)).toFixed(1)}</td></tr>`).join('') : '<tr><td colspan="3" class="text-center text-gray-500">No activities logged.</td></tr>'}</tbody></table></div>`;
            modal.classList.remove('hidden'); modal.classList.add('flex');
        });
        document.getElementById('closeModal').addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); });
    }
    
    function buildStandingsChart(students, isSection = false) {
        const filter = document.getElementById('standingsFilter');
        const classes = [...new Set(students.map(s => `${s.class}-${s.division}`))].sort(customClassSort);
        if (isSection) {
            filter.innerHTML = `<option value="section">Section-wide</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        } else {
            filter.innerHTML = `<option value="school">School-wide</option><option value="lp">LP Section</option><option value="up">UP Section</option><option value="hs">HS Section</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        const updateChart = () => {
            let filteredStudents = students;
            const value = filter.value;
            if (value === 'lp' || value === 'up' || value === 'hs') {
                filteredStudents = students.filter(s => getSection(s.class).toLowerCase() === value);
            } else if (value !== 'school' && value !== 'section') {
                filteredStudents = students.filter(s => `${s.class}-${s.division}` === value);
            }

            const houseData = filteredStudents.reduce((acc, s) => {
                if (!acc[s.house]) acc[s.house] = 0;
                acc[s.house] += s.housePoints;
                return acc;
            }, {});

            const labels = Object.keys(houseData).sort();
            const data = labels.map(house => houseData[house]);
            const backgroundColors = labels.map(house => ({
                'Blue': '#3b82f6', 'Green': '#22c55e', 'Rose': '#f43f5e', 'Yellow': '#f59e0b'
            }[house] || '#a5b4fc'));

            if (standingsChart) standingsChart.destroy();
            standingsChart = new Chart(document.getElementById('standingsChart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Total House Points', data, backgroundColor: backgroundColors }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        };

        filter.addEventListener('change', updateChart);
        updateChart();
    }

    function buildLeaderboardCard(students, activities, isSection = false) {
        const leaderboardCard = document.getElementById('leaderboardCard');
        const classes = [...new Set(students.map(s => `${s.class}-${s.division}`))].sort(customClassSort);
        const filterOptions = isSection 
            ? `<option value="section">Section-wide</option>${classes.map(c => `<option value="${c}">${c}</option>`).join('')}`
            : `<option value="school">School-wide</option><option value="lp">LP</option><option value="up">UP</option><option value="hs">HS</option>${classes.map(c => `<option value="${c}">${c}</option>`).join('')}`;

        leaderboardCard.innerHTML = `
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Discipline Leaderboards</h2>
                    <select id="leaderboardFilter" class="p-2 rounded-lg border border-gray-300">${filterOptions}</select>
                </div>
                <div id="leaderboardContent"></div>
            </div>`;

        const updateLeaderboards = () => {
            const value = document.getElementById('leaderboardFilter').value;
            let filteredStudents = students;
            let filteredActivities = activities;

            if (value === 'lp' || value === 'up' || value === 'hs') {
                const studentAdmNos = new Set(students.filter(s => getSection(s.class).toLowerCase() === value).map(s => s.admissionNo.toString()));
                filteredStudents = students.filter(s => studentAdmNos.has(s.admissionNo.toString()));
                filteredActivities = activities.filter(a => studentAdmNos.has(a.admissionNo.toString()));
            } else if (value !== 'school' && value !== 'section') {
                const studentAdmNos = new Set(students.filter(s => `${s.class}-${s.division}` === value).map(s => s.admissionNo.toString()));
                filteredStudents = students.filter(s => studentAdmNos.has(s.admissionNo.toString()));
                filteredActivities = activities.filter(a => studentAdmNos.has(a.admissionNo.toString()));
            }

            const topPositiveStudents = [...filteredStudents].sort((a, b) => b.disciplinePoints - a.disciplinePoints).slice(0, 5);
            const topNegativeStudents = [...filteredStudents].sort((a, b) => a.disciplinePoints - b.disciplinePoints).slice(0, 5);
            
            const activityPoints = filteredActivities.reduce((acc, act) => {
                const points = (act.Rating / 5) * (activityRules[act.Activity] || 0);
                if (!acc[act.Activity]) acc[act.Activity] = 0;
                acc[act.Activity] += points;
                return acc;
            }, {});

            const sortedActivities = Object.entries(activityPoints).sort((a, b) => b[1] - a[1]);
            const topPositiveActivities = sortedActivities.filter(a => a[1] > 0).slice(0, 5);
            const topNegativeActivities = sortedActivities.filter(a => a[1] < 0).sort((a, b) => a[1] - b[1]).slice(0, 5);

            document.getElementById('leaderboardContent').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold mb-2 text-green-600">Top Students (Positive)</h3>
                        <ul class="divide-y divide-gray-200">${topPositiveStudents.map(s => `<li class="py-2 flex justify-between"><span>${s.name} (${s.class}-${s.division})</span><span class="font-bold text-green-600">${s.disciplinePoints.toFixed(1)}</span></li>`).join('')}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-red-600">Top Students (Negative)</h3>
                        <ul class="divide-y divide-gray-200">${topNegativeStudents.map(s => `<li class="py-2 flex justify-between"><span>${s.name} (${s.class}-${s.division})</span><span class="font-bold text-red-600">${s.disciplinePoints.toFixed(1)}</span></li>`).join('')}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-green-600">Top Positive Activities</h3>
                        <ul class="divide-y divide-gray-200">${topPositiveActivities.map(([name, pts]) => `<li class="py-2 flex justify-between"><span>${name}</span><span class="font-bold text-green-600">${pts.toFixed(1)}</span></li>`).join('')}</ul>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2 text-red-600">Top Negative Activities</h3>
                        <ul class="divide-y divide-gray-200">${topNegativeActivities.map(([name, pts]) => `<li class="py-2 flex justify-between"><span>${name}</span><span class="font-bold text-red-600">${pts.toFixed(1)}</span></li>`).join('')}</ul>
                    </div>
                </div>`;
        };
        
        document.getElementById('leaderboardFilter').addEventListener('change', updateLeaderboards);
        updateLeaderboards();
    }
    
    // --- Universal Topper Filtering UI & Logic ---
    function setupTopperFilters(cardId, students, title, updateFunction) {
        const cardContainer = document.getElementById(cardId);
        if (!cardContainer) return;

        const allTerms = [...new Set(students.flatMap(s => s.marksRecord ? Object.keys(s.marksRecord.terms) : []))];
        
        cardContainer.innerHTML = `
            <div class="dashboard-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div>
                        <label class="text-xs font-medium text-gray-600">Ranking Basis</label>
                        <select id="${cardId}-basis" class="mt-1 block w-full p-2 rounded-lg border border-gray-300">
                            <option value="all-time">All Time</option>
                            ${allTerms.map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Student Group</label>
                        <select id="${cardId}-scope" class="mt-1 block w-full p-2 rounded-lg border border-gray-300">
                            <option value="school">School-wide</option>
                            <option value="section">By Section</option>
                            <option value="standard">By Standard</option>
                            <option value="division">By Division</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Detail</label>
                        <select id="${cardId}-detail" class="mt-1 block w-full p-2 rounded-lg border border-gray-300" disabled><option value="">-</option></select>
                    </div>
                    <div>
                        <button id="${cardId}-resetBtn" class="w-full bg-slate-200 text-slate-700 p-2 rounded-lg font-medium">Reset</button>
                    </div>
                </div>
                <div id="${cardId}-content">
                    <p class="text-gray-500">Please make a selection to view toppers.</p>
                </div>
            </div>`;
        
        const basisEl = document.getElementById(`${cardId}-basis`);
        const scopeEl = document.getElementById(`${cardId}-scope`);
        const detailEl = document.getElementById(`${cardId}-detail`);
        const resetBtn = document.getElementById(`${cardId}-resetBtn`);

        const triggerUpdate = () => {
            const basis = basisEl.value;
            const scope = scopeEl.value;
            const detail = detailEl.value;
            updateFunction(students, basis, scope, detail, `${cardId}-content`);
        };

        scopeEl.addEventListener('change', () => {
            const scope = scopeEl.value;
            detailEl.innerHTML = '<option value="">Select</option>';
            detailEl.disabled = true;
            
            let options = [];
            if (scope === 'section') {
                options = [...new Set(students.map(s => getSection(s.class)))];
            } else if (scope === 'standard') {
                options = [...new Set(students.map(s => s.class))].sort((a,b) => a-b);
            } else if (scope === 'division') {
                options = [...new Set(students.map(s => `${s.class}-${s.division}`))].sort(customClassSort);
            }

            if (options.length > 0) {
                detailEl.innerHTML = options.map(o => `<option value="${o}">${o}</option>`).join('');
                detailEl.disabled = false;
            } else {
                detailEl.innerHTML = '<option value="">-</option>';
            }
            triggerUpdate();
        });

        resetBtn.addEventListener('click', () => {
            basisEl.value = 'all-time';
            scopeEl.value = 'school';
            scopeEl.dispatchEvent(new Event('change'));
        });

        basisEl.addEventListener('change', triggerUpdate);
        detailEl.addEventListener('change', triggerUpdate);
        triggerUpdate(); // Initial call
    }
    
    function updateClassToppersView(students, basis, scope, detail, contentId) {
        const contentEl = document.getElementById(contentId);
        let filteredStudents = students;

        if (scope === 'section' && detail) {
            filteredStudents = students.filter(s => getSection(s.class) === detail);
        } else if (scope === 'standard' && detail) {
            filteredStudents = students.filter(s => s.class.toString() === detail.toString());
        } else if (scope === 'division' && detail) {
            filteredStudents = students.filter(s => `${s.class}-${s.division}` === detail);
        }
        
        let finalTopperList;
        let isRankedList = false;
        let rankHeader = "Rank";

        if ((scope === 'division' && detail) || (scope === 'standard' && detail)) {
            isRankedList = true;
            rankHeader = "Rank";
            let sortedStudents;
            if (basis === 'all-time') {
                sortedStudents = [...filteredStudents].sort((a, b) => b.academicTotal - a.academicTotal);
            } else {
                sortedStudents = [...filteredStudents]
                    .map(s => ({ ...s, termTotal: s.marksRecord?.terms?.[basis]?.total ?? -1 }))
                    .filter(s => s.termTotal !== -1)
                    .sort((a, b) => b.termTotal - a.termTotal);
            }
            finalTopperList = sortedStudents.slice(0, 10);
        } else {
            isRankedList = false;
            rankHeader = "Class";
            const uniqueDivisions = [...new Set(filteredStudents.map(s => `${s.class}-${s.division}`))].sort(customClassSort);
            
            finalTopperList = uniqueDivisions.map(division => {
                let divisionStudents = filteredStudents.filter(s => `${s.class}-${s.division}` === division);
                let sortedDivisionStudents;
                if (basis === 'all-time') {
                    sortedDivisionStudents = [...divisionStudents].sort((a, b) => b.academicTotal - a.academicTotal);
                } else {
                    sortedDivisionStudents = [...divisionStudents]
                        .map(s => ({ ...s, termTotal: s.marksRecord?.terms?.[basis]?.total ?? -1 }))
                        .filter(s => s.termTotal !== -1)
                        .sort((a, b) => b.termTotal - a.termTotal);
                }
                return sortedDivisionStudents.length > 0 ? sortedDivisionStudents[0] : null;
            }).filter(Boolean);
        }

        if (finalTopperList.length === 0) {
            contentEl.innerHTML = `<p class="text-gray-500">No data available for this selection.</p>`;
            return;
        }

        contentEl.innerHTML = `
            <div class="overflow-x-auto">
                <table class="custom-table">
                    <thead><tr><th>${rankHeader}</th><th>Name</th><th>Score</th></tr></thead>
                    <tbody>
                        ${finalTopperList.map((s, i) => `
                            <tr>
                                <td class="font-bold">${isRankedList ? i + 1 : `${s.class}-${s.division}`}</td>
                                <td>${s.name} ${!isRankedList ? '' : `(${s.class}-${s.division})`}</td>
                                <td>${(basis === 'all-time' ? s.academicTotal : s.termTotal).toFixed(0)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function buildClassToppersCard(students) {
        setupTopperFilters('classToppersCard', students, 'Class Toppers', updateClassToppersView);
    }
    
    function updateSubjectToppersView(students, basis, scope, detail, contentId) {
        const contentEl = document.getElementById(contentId);
        const term = (basis === 'all-time') ? null : basis;

        if (!term) {
            contentEl.innerHTML = `<p class="text-gray-500">Please select a specific exam to view subject toppers.</p>`;
            return;
        }

        let filteredStudents = students;
        if (scope === 'section' && detail) {
            filteredStudents = students.filter(s => getSection(s.class) === detail);
        } else if (scope === 'standard' && detail) {
            filteredStudents = students.filter(s => s.class.toString() === detail.toString());
        } else if (scope === 'division' && detail) {
            filteredStudents = students.filter(s => `${s.class}-${s.division}` === detail);
        }
        
        if (!filteredStudents.length) {
            contentEl.innerHTML = `<p class="text-gray-500">No students found for this selection.</p>`;
            return;
        }
        
        const subjects = [...new Set(filteredStudents.flatMap(s => 
            s.marksRecord?.terms?.[term] ? Object.keys(s.marksRecord.terms[term].marks) : []
        ))].sort();

        if (subjects.length === 0) {
            contentEl.innerHTML = `<p class="text-gray-500">No subjects found for this selection.</p>`;
            return;
        }

        let toppersHTML = '';
        subjects.forEach(subject => {
            let toppers = [];
            
            if (scope === 'school' || scope === 'section' || scope === 'standard') {
                const groupingKeyFn = (scope === 'standard') 
                    ? s => `${s.class}-${s.division}` 
                    : s => s.class;
                
                const groupsToIterate = (scope === 'standard')
                    ? [...new Set(filteredStudents.map(groupingKeyFn))].sort(customClassSort)
                    : [...new Set(filteredStudents.map(groupingKeyFn))].sort((a,b) => parseInt(a, 10) - parseInt(b, 10));

                groupsToIterate.forEach(group => {
                    const groupStudents = filteredStudents.filter(s => groupingKeyFn(s) == group);
                    
                    let topScore = -1;
                    let groupTopper = null; 
                    groupStudents.forEach(student => {
                        const mark = student.marksRecord?.terms?.[term]?.marks?.[subject];
                        if (typeof mark === 'number' && mark > topScore) {
                            topScore = mark;
                            groupTopper = student;
                        }
                    });

                    if (groupTopper) {
                        toppers.push(`${groupTopper.name} (${groupTopper.class}-${groupTopper.division})`);
                    }
                });
            } else { // scope === 'division'
                let topScore = -1;
                filteredStudents.forEach(student => {
                    const mark = student.marksRecord?.terms?.[term]?.marks?.[subject];
                    if (typeof mark === 'number') {
                        if (mark > topScore) {
                            topScore = mark;
                            toppers = [`${student.name} (${student.class}-${student.division})`];
                        } else if (mark === topScore) {
                            toppers.push(`${student.name} (${student.class}-${student.division})`);
                        }
                    }
                });
            }
            
            if (toppers.length > 0) {
                const firstTopperFullName = toppers[0];
                const firstTopperData = filteredStudents.find(s => firstTopperFullName.startsWith(s.name));
                if (firstTopperData) {
                    const { maxMark } = getGradeInfo(0, subject, term, firstTopperData.class);
                     toppersHTML += `
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <h4 class="font-bold text-gray-700">${subject}</h4>
                            <p class="text-sm text-gray-500">Max Mark: <span class="font-semibold themed-text">${maxMark}</span></p>
                            <p class="text-sm">${toppers.join(', ')}</p>
                        </div>`;
                }
            }
        });

        contentEl.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${toppersHTML}</div>`;
        if(!toppersHTML) {
             contentEl.innerHTML = `<p class="text-gray-500">No marks recorded for this selection.</p>`;
        }
    }

    function buildSubjectToppersCard(students) {
        setupTopperFilters('subjectToppersCard', students, 'Subject Toppers', updateSubjectToppersView);
    }
    
    function buildReportGeneratorCard(students) {
        const cardContainer = document.getElementById('reportGeneratorCard');
        if (!cardContainer) return;

        const classes = [...new Set(students.map(s => `${s.class}-${s.division}`))].sort(customClassSort);
        
        cardContainer.innerHTML = `
            <div class="dashboard-card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Report Generator</h2>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                    <div class="md:col-span-1"><label for="report-class" class="text-sm font-medium text-gray-700">Class</label><select id="report-class" class="mt-1 block w-full p-2 rounded-lg border border-gray-300"><option value="">Select Class</option>${classes.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                    <div class="md:col-span-1"><label for="report-term" class="text-sm font-medium text-gray-700">Term</label><select id="report-term" class="mt-1 block w-full p-2 rounded-lg border border-gray-300" disabled><option value="">Select Term</option></select></div>
                    <div class="md:col-span-1"><label for="report-subject" class="text-sm font-medium text-gray-700">Subject</label><select id="report-subject" class="mt-1 block w-full p-2 rounded-lg border border-gray-300" disabled><option value="">Select Subject</option></select></div>
                    <button id="generateReportBtn" class="w-full text-white themed-bg p-2 rounded-lg font-medium" disabled>Generate</button>
                    <button id="resetReportBtn" class="w-full bg-slate-200 text-slate-700 p-2 rounded-lg font-medium">Reset</button>
                </div>
                <div id="reportResultContainer" class="mt-6"></div>
            </div>`;

        const classSelect = document.getElementById('report-class');
        const termSelect = document.getElementById('report-term');
        const subjectSelect = document.getElementById('report-subject');
        const generateBtn = document.getElementById('generateReportBtn');
        const resetBtn = document.getElementById('resetReportBtn');
        const resultContainer = document.getElementById('reportResultContainer');

        const resetGenerator = () => {
            classSelect.value = '';
            termSelect.innerHTML = '<option value="">Select Term</option>';
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            termSelect.disabled = true; subjectSelect.disabled = true; generateBtn.disabled = true;
            resultContainer.innerHTML = '';
        };

        classSelect.addEventListener('change', () => {
            termSelect.innerHTML = '<option value="">Select Term</option>';
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            termSelect.disabled = true; subjectSelect.disabled = true; generateBtn.disabled = true;
            
            const className = classSelect.value;
            if (!className) return;

            const classStudents = students.filter(s => `${s.class}-${s.division}` === className);
            if (classStudents.length === 0) return;
            
            const terms = [...new Set(classStudents.flatMap(s => s.marksRecord ? Object.keys(s.marksRecord.terms) : []))];
            termSelect.innerHTML += terms.map(t => `<option value="${t}">${t}</option>`).join('');
            termSelect.disabled = false;
        });

        termSelect.addEventListener('change', () => {
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            subjectSelect.disabled = true; generateBtn.disabled = true;
            
            const className = classSelect.value;
            const term = termSelect.value;
            if (!className || !term) return;

            const classStudents = students.filter(s => `${s.class}-${s.division}` === className);
            const subjects = [...new Set(classStudents.flatMap(s => s.marksRecord?.terms?.[term] ? Object.keys(s.marksRecord.terms[term].marks) : []))].sort();
            
            subjectSelect.innerHTML += subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            subjectSelect.disabled = false;
        });

        subjectSelect.addEventListener('change', () => { generateBtn.disabled = !subjectSelect.value; });
        resetBtn.addEventListener('click', resetGenerator);

        generateBtn.addEventListener('click', () => {
            const className = classSelect.value;
            const term = termSelect.value;
            const subject = subjectSelect.value;
            
            const classStudents = students.filter(s => `${s.class}-${s.division}` === className)
                .sort((a, b) => {
                    if (a.gender < b.gender) return -1; // 'F' before 'M'
                    if (a.gender > b.gender) return 1;
                    return a.name.localeCompare(b.name); // Then sort by name
                });

            let tableHTML = `<div class="overflow-x-auto"><table id="reportTable" class="custom-table"><thead><tr><th>Name</th><th>Mark</th><th>Grade</th></tr></thead><tbody>`;
            let clipboardText = "Grade\n"; // Header for clipboard

            classStudents.forEach(s => {
                const mark = s.marksRecord?.terms?.[term]?.marks?.[subject];
                const displayMark = (typeof mark === 'number') ? mark : 'Ab';
                const { grade, maxMark } = getGradeInfo(mark, subject, term, s.class);
                
                tableHTML += `<tr><td>${s.name}</td><td>${displayMark} / ${maxMark}</td><td>${grade}</td></tr>`;
                clipboardText += `${grade}\n`;
            });

            tableHTML += '</tbody></table></div><div class="mt-4 text-right"><button id="copyReportBtn" class="action-btn themed-bg">Copy Grades</button></div>';
            resultContainer.innerHTML = tableHTML;

            document.getElementById('copyReportBtn').addEventListener('click', (e) => {
                navigator.clipboard.writeText(clipboardText).then(() => {
                    const btn = e.target;
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Grades'; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Could not copy text to clipboard.');
                });
            });
        });
    }

    // --- MAIN APPLICATION FLOW ---
    const loginView = document.getElementById('loginView');
    const dashboardView = document.getElementById('dashboardView');
    const progressBar = document.getElementById('progressBarContainer');

    function showProgressBar() { progressBar.classList.remove('hidden'); }
    function hideProgressBar() { progressBar.classList.add('hidden'); }

    function showDashboard(user) {
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        document.getElementById('userInfo').innerHTML = `<p class="font-semibold text-gray-800">${user.name}</p><p class="text-xs text-gray-500">${user.designation || 'Student'}</p>`;
        const headerTitle = document.getElementById('headerTitle');
        document.body.className = 'bg-slate-100 font-sans';
        if (user.designation === 'HM') {
            document.body.classList.add('theme-hm');
        } else if (user.role === 'staff') {
            document.body.classList.add('theme-teacher');
        } else if (user.role === 'student' && user.house) {
            document.body.classList.add(`theme-${user.house.toLowerCase()}`);
        }
        headerTitle.classList.add('themed-text');
    }

    function showLogin() {
        dashboardView.classList.add('hidden');
        loginView.classList.remove('hidden');
        document.body.className = 'bg-slate-100 font-sans';
    }

    async function handleLogin(event) {
        event.preventDefault();
        showProgressBar();
        const phone = document.getElementById('phone').value;
        const dob = document.getElementById('dob').value;
        const errorElement = document.getElementById('loginError');
        errorElement.textContent = '';
        try {
            const dataLoaded = await isDataLoaded();
            if (!dataLoaded) {
                await populateDB();
            }
            const usersRes = await fetch('./users.json');
            if (!usersRes.ok) throw new Error('Could not fetch user list for authentication.');
            const users = await usersRes.json();
            
            const foundUser = users.find(user => {
                const phoneMatch = Array.isArray(user.phone) 
                    ? user.phone.includes(phone) 
                    : user.phone === phone;
                return phoneMatch && user.dob === dob;
            });

            if (foundUser) {
                await setSession(foundUser);
                initializeApp(foundUser);
            } else {
                errorElement.textContent = 'Invalid credentials. Please try again.';
                hideProgressBar();
            }
        } catch (error) {
            console.error('Login Error:', error);
            errorElement.textContent = 'An error occurred. Please try again.';
            hideProgressBar();
        }
    }

    async function initializeApp(loggedInUser) {
        if (!loggedInUser) {
            showLogin();
            return;
        }
        showProgressBar();
        currentUser = loggedInUser;
        showDashboard(loggedInUser);
        
        const { users, marks, activities, metadata } = await getAllData();
        const allStudents = users.filter(u => u.role === 'student');
        const processedStudents = processStudentData(allStudents, marks, activities);
        
        appData = { users, marks, activities, processedStudents };

        const searchContainer = document.getElementById('header-search-container');
        const searchInput = document.getElementById('headerSearch');
        const searchResultsEl = document.getElementById('headerSearchResults');

        if (loggedInUser.designation === 'HM' || loggedInUser.role === 'staff') {
            searchContainer.classList.remove('hidden');
            let searchableStudents = loggedInUser.designation === 'HM' 
                ? processedStudents 
                : processedStudents.filter(s => getSection(s.class) === getTeacherSection(loggedInUser.designation));
            
            searchInput.addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                if (!query) { searchResultsEl.innerHTML = ''; return; }
                const results = searchableStudents.filter(s => s.name.toLowerCase().includes(query) || s.admissionNo.toString().includes(query));
                searchResultsEl.innerHTML = results.length > 0 ? `<ul class="divide-y divide-gray-200">${results.map(s => `<li class="p-2 hover:bg-slate-100 cursor-pointer view-student-btn" data-admission-no="${s.admissionNo}">${s.name} - ${s.class}${s.division}</li>`).join('')}</ul>` : `<div class="p-2 text-gray-500">No students found.</div>`;
            });
             searchResultsEl.addEventListener('click', e => {
                if (e.target.classList.contains('view-student-btn')) {
                    const student = appData.processedStudents.find(s => s.admissionNo.toString() === e.target.dataset.admissionNo.toString());
                    if (student) buildStudentDashboard(student, appData.activities, currentUser);
                    searchInput.value = '';
                    searchResultsEl.innerHTML = '';
                }
            });
        } else {
            searchContainer.classList.add('hidden');
        }

        if (loggedInUser.designation === 'HM') {
            buildHMDashboard(loggedInUser, allStudents, processedStudents, metadata);
        } else if (loggedInUser.role === 'staff') {
            buildTeacherDashboard(loggedInUser, allStudents, processedStudents, metadata);
        } else if (loggedInUser.role === 'student') {
            const siblings = allStudents.filter(s => {
                if (s.admissionNo.toString() === loggedInUser.admissionNo.toString()) return false;
                const currentUserPhones = Array.isArray(loggedInUser.phone) ? loggedInUser.phone : [loggedInUser.phone];
                const potentialSiblingPhones = Array.isArray(s.phone) ? s.phone : [s.phone];
                return currentUserPhones.some(p => potentialSiblingPhones.includes(p));
            });
            const studentData = processedStudents.find(s => s.admissionNo.toString() === loggedInUser.admissionNo.toString());
            if (studentData) buildStudentDashboard(studentData, activities, null, siblings);
        }
        hideProgressBar();
    }
    
    function openIframeModal(url, title) {
        const modal = document.getElementById('iframeModal');
        document.getElementById('iframeModalTitle').textContent = title;
        document.getElementById('modalIframe').src = url;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function handleDashboardClick(event) {
        const target = event.target.closest('button, a');
        if (!target) return;

        if (target.classList.contains('view-student-btn')) {
            const student = appData.processedStudents.find(s => s.admissionNo.toString() === target.dataset.admissionNo.toString());
            if (student) buildStudentDashboard(student, appData.activities, currentUser);
        }
        if (target.classList.contains('action-btn')) {
            const action = target.dataset.action;
            if (action === 'discipline') {
                const url = "https://forms.gle/WMmnHUghyBWRckr46";
                openIframeModal(url, "Record Discipline Points");
            }
        }
    }
    
    function showSwitchChildModal(siblings) {
        const modal = document.getElementById('switchChildModal');
        const listEl = document.getElementById('switchChildList');
        listEl.innerHTML = `<ul class="divide-y divide-gray-200">${siblings.map(s => `<li class="p-4 hover:bg-slate-100 cursor-pointer switch-child-item" data-admission-no="${s.admissionNo}">${s.name} - Class ${s.class}${s.division}</li>`).join('')}</ul>`;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // --- EVENT LISTENERS & INITIALIZATION ---
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('logoutButton').addEventListener('click', async () => {
        await clearSessionAndData();
        showLogin();
    });
    document.getElementById('closeIframeModal').addEventListener('click', () => {
        const modal = document.getElementById('iframeModal');
        document.getElementById('modalIframe').src = "about:blank";
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });
    
    const switchChildModal = document.getElementById('switchChildModal');
    const dobVerifyModal = document.getElementById('dobVerifyModal');

    document.getElementById('closeSwitchChildModal').addEventListener('click', () => switchChildModal.classList.add('hidden'));
    document.getElementById('closeDobVerifyModal').addEventListener('click', () => dobVerifyModal.classList.add('hidden'));

    document.getElementById('switchChildList').addEventListener('click', e => {
        if (e.target.classList.contains('switch-child-item')) {
            const admNo = e.target.dataset.admissionNo;
            document.getElementById('dobVerifyAdmissionNo').value = admNo;
            switchChildModal.classList.add('hidden');
            dobVerifyModal.classList.remove('hidden');
            dobVerifyModal.classList.add('flex');
        }
    });

    document.getElementById('dobVerifyForm').addEventListener('submit', async e => {
        e.preventDefault();
        const admNo = document.getElementById('dobVerifyAdmissionNo').value;
        const dob = document.getElementById('dobVerifyInput').value;
        const errorEl = document.getElementById('dobError');
        errorEl.textContent = '';
        
        const targetStudent = appData.users.find(s => s.role === 'student' && s.admissionNo.toString() === admNo);
        if (targetStudent && targetStudent.dob === dob) {
            await setSession(targetStudent);
            dobVerifyModal.classList.add('hidden');
            initializeApp(targetStudent);
        } else {
            errorEl.textContent = "Incorrect date of birth. Please try again.";
        }
    });

    getSession().then(user => initializeApp(user));

</script>
</body>
</html>